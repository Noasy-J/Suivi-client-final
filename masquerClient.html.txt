<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <style>
    :root{
      --primary:#3b82f6; --accent:#22d3ee; --danger:#dc2626;
      --bg:#ffffff; --border:#e5e7eb; --text:#0f172a; --muted:#475569;
    }
    *{box-sizing:border-box}
    body{
      margin:0;padding:16px;font:14px/1.4 Inter,Arial,sans-serif;
      background:linear-gradient(180deg,#f1f5f9,#fff);color:var(--text);
    }
    h2{margin:0 0 16px;font-size:20px}
    label{font-size:14px;color:var(--muted);display:block;margin:12px 0 4px}
    select,input[type="date"]{
      width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;
      background:#fff;font-size:14px;outline:none;
    }
    select:focus,input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(59,130,246,.2)}
    .actions{display:flex;gap:8px;margin:14px 0}
    button{flex:1;padding:10px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff}
    .btn-alt{background:#e0e7ff;color:#1e3a8a}
    .btn-danger{background:var(--danger);color:#fff}
    .masked-item{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;margin-top:6px;border:1px solid var(--border);border-radius:8px}
    .empty{color:var(--muted);font-style:italic;margin-top:6px}
    .card{max-width:760px;margin:0 auto;background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(2,6,23,.08)}
  </style>
</head>
<body>
  <div class="card">
    <h2>Masquer un client</h2>

    <label for="clientSelect">Client :</label>
    <select id="clientSelect"><option>Chargement…</option></select>

    <label for="dateInput">Masquer jusqu’au :</label>
    <input type="date" id="dateInput">

    <div class="actions">
      <button type="button" class="btn-primary" onclick="maskByDate(this)">Masquer par date</button>
      <button type="button" class="btn-alt" onclick="maskUntilNext(this)">Jusqu’à la prochaine intervention</button>
    </div>

    <h3>Clients masqués</h3>
    <div id="maskedList"></div>
  </div>

  <script>
    const INITIAL = <?!= initialDataJson ?>; // {ok, clients, masked}
  </script>

  <script>
    const $ = id => document.getElementById(id);
    const setBusy = d => document.querySelectorAll('button').forEach(b => b.disabled = d);

    function callServer(fnNames, args, onOk, btn){
      if(!google || !google.script || !google.script.run){
        alert('google.script.run indisponible'); return;
      }
      btn && (btn.disabled = true);
      const names = Array.isArray(fnNames)?fnNames:[fnNames];
      let i=0;
      const tryNext=()=>{
        const name=names[i++]; if(!name){ alert('Fonction serveur introuvable'); btn && (btn.disabled = false); return; }
        try{
          const r=google.script.run
            .withSuccessHandler(res=>{ btn && (btn.disabled = false); if(res && res.ok===false){ alert(res.message||'Erreur serveur'); return; } onOk && onOk(res); })
            .withFailureHandler(err=>{ btn && (btn.disabled = false); alert((err&&err.message)||'Erreur Apps Script'); });
          args===undefined ? r[name]() : r[name](args);
        }catch(e){ tryNext(); }
      };
      tryNext();
    }

    function renderClientsDropdown(list){
      const sel=$('clientSelect'); sel.innerHTML='';
      if(!list || !list.length){ const o=document.createElement('option'); o.value=''; o.textContent='— Aucun client —'; sel.appendChild(o); return; }
      list.forEach(c=>{ const o=document.createElement('option'); o.value=c.key; o.textContent=c.label; sel.appendChild(o); });
    }

    function renderMaskedList(arr){␊
      const cont=$('maskedList'); cont.innerHTML='';␊
      if(!arr || !arr.length){ cont.innerHTML='<div class="empty">Aucun client masqué.</div>'; return; }␊
      arr.forEach(m=>{␊
        const div=document.createElement('div'); div.className='masked-item';␊
        const span=document.createElement('span');␊
        span.innerHTML='<b>'+m.label+'</b>'+(m.untilISO?' <small>(jusqu\u2019au '+m.untilISO+')</small>':'');␊
        const btn=document.createElement('button'); btn.type='button'; btn.className='btn-danger'; btn.textContent='Démasquer';␊
        btn.onclick=()=>{ setBusy(true); callServer(['uiUnmaskClient_','uiUnmaskClient'], m.key, ()=>refreshUI(()=>setBusy(false))); };
        div.appendChild(span); div.appendChild(btn); cont.appendChild(div);␊
      });␊
    }␊

    function hydrate(){
      $('dateInput').min = new Date().toISOString().slice(0,10);
      if(!INITIAL || INITIAL.ok===false){
        refreshUI();
        if(INITIAL && INITIAL.ok===false){
          alert(INITIAL.message || 'Erreur serveur');
        }
        return;
      }
      renderClientsDropdown(INITIAL.clients);
      renderMaskedList(INITIAL.masked);
    }

    function refreshUI(cb){
      $('dateInput').min = new Date().toISOString().slice(0,10);
      callServer(['uiListClientsPourMasquageV2_','uiListClientsPourMasquage_'], undefined, res=>{
        renderClientsDropdown(res.clients);
        renderMaskedList(res.masked);
        cb && cb();
      });
    }

    function maskByDate(){
      const key=$('clientSelect').value, d=$('dateInput').value;
      if(!key) return alert('Sélectionnez un client');
      if(!d) return alert('Choisissez une date');
      setBusy(true);
      callServer(['uiMaskClient_','uiMaskClient'], {key,mode:'date',dateISO:d}, ()=>refreshUI(()=>setBusy(false)));
    }

    function maskUntilNext(){
      const key=$('clientSelect').value;
      if(!key) return alert('Sélectionnez un client');
      setBusy(true);
      callServer(['uiMaskClient_','uiMaskClient'], {key,mode:'next'}, ()=>refreshUI(()=>setBusy(false)));
    }

    document.addEventListener('DOMContentLoaded', hydrate);
  </script>
</body>
</html>
