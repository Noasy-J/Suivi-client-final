<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 12px; }
    h2 { margin: 0 0 8px; }
    .row { display:flex; gap:8px; align-items:center; margin:8px 0; }
    select, input[type="date"] { padding:6px; }
    button { padding:6px 10px; cursor:pointer; }
    .list { margin-top:12px; border-top:1px solid #ddd; padding-top:10px; }
    .masked-item { display:flex; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #eee; }
    small { color:#666; }
  </style>
</head>
<body>
  <h2>Masquer un client</h2>

  <div class="row">
    <label>Client :</label>
    <select id="clientSelect"></select>
  </div>

  <div class="row">
    <label>Masquer jusqu’au :</label>
    <input type="date" id="dateInput">
    <button onclick="maskByDate()">Masquer par date</button>
    <button onclick="maskUntilNext()">Jusqu’à la prochaine planification</button>
  </div>

  <div class="list">
    <h3>Clients masqués</h3>
    <div id="maskedList"></div>
  </div>

  <script>
    function refreshUI() {
      google.script.run.withSuccessHandler(({clients, masked})=>{
        const sel = document.getElementById('clientSelect');
        sel.innerHTML = '';
        clients.forEach(c=>{
          const opt = document.createElement('option');
          opt.value = c.key; opt.textContent = c.label;
          sel.appendChild(opt);
        });

        const list = document.getElementById('maskedList');
        list.innerHTML = '';
        if (!masked.length) {
          list.textContent = 'Aucun client masqué.';
          return;
        }
        masked.forEach(m=>{
          const div = document.createElement('div');
          div.className = 'masked-item';
          const span = document.createElement('span');
          span.textContent = m.label + (m.untilISO ? ' — jusqu’au ' + m.untilISO : '');
          const btn = document.createElement('button');
          btn.textContent = 'Démasquer';
          btn.onclick = ()=> google.script.run.withSuccessHandler(refreshUI).uiUnmaskClient_(m.key);
          div.appendChild(span); div.appendChild(btn);
          list.appendChild(div);
        });
      }).uiListClientsPourMasquage_();
    }

    function maskByDate() {
      const key = document.getElementById('clientSelect').value;
      const d = document.getElementById('dateInput').value;
      if (!key) { alert('Sélectionnez un client.'); return; }
      if (!d) { alert('Choisissez une date.'); return; }
      google.script.run.withSuccessHandler((r)=>{
        if (!r.ok) { alert(r.message||'Erreur.'); return; }
        refreshUI();
      }).uiMaskClient_({key, mode:'date', dateISO:d});
    }

    function maskUntilNext() {
      const key = document.getElementById('clientSelect').value;
      if (!key) { alert('Sélectionnez un client.'); return; }
      google.script.run.withSuccessHandler((r)=>{
        if (!r.ok) { alert(r.message||'Erreur.'); return; }
        refreshUI();
      }).uiMaskClient_({key, mode:'next'});
    }

    document.addEventListener('DOMContentLoaded', refreshUI);
  </script>
</body>
</html>
